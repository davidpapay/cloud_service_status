# CI/CD Workflow for Cloud Service Status

name: CI/CD Cloud Service Status

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: cloud-service-status
  DEV_DIR: infra/dev
  PROD_DIR: infra/prod

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install Python dependencies
        run: pip install -r src/requirements.txt

      - name: Build Docker image
        run: docker build -t ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} -f Dockerfile .

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io # GitHub container registry
          username: ${{ github.actor }} # GitHub username
          password: ${{ secrets.GITHUB_TOKEN }} # token generated by GitHub

      - name: Push Docker image
        run: |
          docker tag ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} ghcr.io/${{ github.repository_owner }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          docker push ghcr.io/${{ github.repository_owner }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}

  terraform-plan:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0

      - name: Terraform Init & Plan (Dev)
        run: |
          terraform -chdir=${{ env.DEV_DIR }} init
          terraform -chdir=${{ env.DEV_DIR }} plan -out=tfplan-dev

      - name: Terraform Init & Plan (Prod)
        run: |
          terraform -chdir=${{ env.PROD_DIR }} init
          terraform -chdir=${{ env.PROD_DIR }} plan -out=tfplan-prod

  mock-apply:
    runs-on: ubuntu-latest
    needs: terraform-plan
    steps:
      - name: Simulate Apply (Dev)
        run: |
          echo "ðŸ”¹ Simulating Terraform apply for dev..."
          terraform -chdir=${{ env.DEV_DIR }} show -no-color tfplan-dev

      - name: Simulate Apply (Prod)
        run: |
          echo "ðŸ”¹ Simulating Terraform apply for prod..."
          terraform -chdir=${{ env.PROD_DIR }} show -no-color tfplan-prod
