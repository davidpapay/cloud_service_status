# CI/CD Workflow for Cloud Service Status

name: CI/CD Cloud Service Status

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: cloud-service-status
  DEV_DIR: infra/dev
  PROD_DIR: infra/prod

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    permissions:
      contents: read  # read repository
      packages: write # needed for push to GHCR

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io # GitHub container registry
          username: ${{ github.actor }} # GitHub username
          password: ${{ secrets.GITHUB_TOKEN }} # token generated by GitHub

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # add lastest tag and commit ID tag
          tags: |
            ghcr.io/${{ github.repository_owner }}/cloud_service_status:latest
            ghcr.io/${{ github.repository_owner }}/cloud_service_status:${{ github.sha }}

  terraform-plan:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v2
        with:
          # use SP credentials stored in GitHub Secrets
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.14.0

      - name: Terraform Init & Plan (Dev)
        run: |
          terraform -chdir=${{ env.DEV_DIR }} init
          terraform -chdir=${{ env.DEV_DIR }} plan -out=tfplan-dev

      - name: Terraform Init & Plan (Prod)
        run: |
          terraform -chdir=${{ env.PROD_DIR }} init
          terraform -chdir=${{ env.PROD_DIR }} plan -out=tfplan-prod

  mock-apply:
    runs-on: ubuntu-latest
    needs: terraform-plan
    steps:
      - name: Simulate Apply (Dev)
        run: |
          echo "ðŸ”¹ Simulating Terraform apply for dev..."
          terraform -chdir=${{ env.DEV_DIR }} show -no-color tfplan-dev

      - name: Simulate Apply (Prod)
        run: |
          echo "ðŸ”¹ Simulating Terraform apply for prod..."
          terraform -chdir=${{ env.PROD_DIR }} show -no-color tfplan-prod